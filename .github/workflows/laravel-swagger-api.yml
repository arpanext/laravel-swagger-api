name: laravel-swagger-api

on:
  push:
    branches: [ master ]
  #pull_request:
  #  branches: [ master ]

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Create a temp folder
        run: mkdir -p /tmp/packages/arpanext/laravel-swagger-api
      - name: Move the package source
        run: mv -v $(ls -A .) /tmp/packages/arpanext/laravel-swagger-api
      - name: Create a laravel project
        run: composer create-project laravel/laravel .
      - name: Move the package source
        run: mv -v /tmp/packages .
      - name: Register the package into the composer.json
        run: sed -i '/"require"/i \ \ \ \ "repositories":[{ "type":"path","url":"./packages/arpanext/laravel-swagger-api","options":{"symlink":true}}],' ./composer.json
      - name: Dumps the autoloader
        run: composer dumpautoload
      - name: Install the package
        run: composer require arpanext/laravel-swagger-api
      - name: Publish the package config
        run: php artisan vendor:publish --provider=Arpanext\\SwaggerApi\\App\\Providers\\AppServiceProvider --tag="config"
      - name: Create a controllers api folder
        run: mkdir -p app/Http/Controllers/Api
      - name: Copy examples to the controllers api folder
        run: cp -r ./vendor/zircote/swagger-php/Examples/petstore-3.0 ./app/Http/Controllers/Api/petstore-3.0
      - name: Zip
        run: zip -r project.zip .
      - uses: actions/upload-artifact@master
        with:
          name: artifact
          path: project.zip
  tests:
    needs: [install]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@master
        with:
          name: artifact
          path: ${{ github.workspace }}/project.zip
      - name: Unzip
        run: unzip -l ./project.zip
      - name: Run tests
        run: vendor/bin/phpunit packages/arpanext/laravel-swagger-api --configuration=packages/arpanext/laravel-swagger-api/phpunit.xml --coverage-text
      

